**"ì‹¤ì „ ì‹œë®¬ë ˆì´ì…˜"**.
 [ë°”ì½”ë“œ ìŠ¤ìº” â†’ ì œí’ˆ ì¸ì‹(ì˜ˆì¸¡) â†’ ë” ê±´ê°•í•œ ì œí’ˆ ì¶”ì²œ] ê³¼ì •ì„ ì™„ë²½í•˜ê²Œ êµ¬í˜„í•˜ëŠ” ì½”ë“œ

Python

import pandas as pd
import pymysql
import joblib
import os
import numpy as np

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. ì„¤ì • ë° ëª¨ë¸ ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR = r'C:\Users\smhrd\ì‹¤ì „í”„ë¡œì íŠ¸\csvëª¨ìŒ'
MODEL_PATH = os.path.join(BASE_DIR, 'food_classifier_rf.pkl')
VECTORIZER_PATH = os.path.join(BASE_DIR, 'tfidf_vectorizer.pkl')

# DB ì ‘ì† ì •ë³´
DB_CONFIG = {
    'host': 'localhost',
    'user': 'root',
    'password': '1234',
    'db': 'app_db',
    'charset': 'utf8mb4',
    'cursorclass': pymysql.cursors.DictCursor
}

print("ğŸ§  AI ëª¨ë¸ê³¼ ë²¡í„°ë¼ì´ì €ë¥¼ ë¡œë”© ì¤‘...")
try:
    rf_model = joblib.load(MODEL_PATH)
    vectorizer = joblib.load(VECTORIZER_PATH)
    print("âœ… ë¡œë”© ì™„ë£Œ!")
except FileNotFoundError:
    print("âŒ ëª¨ë¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
    exit()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. í•µì‹¬ ê¸°ëŠ¥: ê±´ê°•í•œ ëŒ€ì²´í’ˆ ì¶”ì²œ ë¡œì§
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def find_healthier_alternatives(category, current_sugar, current_kcal, current_report_no=None):
    conn = pymysql.connect(**DB_CONFIG)
    recommendations = []
    
    try:
        with conn.cursor() as cursor:
            # ë¡œì§: ê°™ì€ ì¹´í…Œê³ ë¦¬ì´ë©´ì„œ ë‹¹ë¥˜ë‚˜ ì¹¼ë¡œë¦¬ê°€ ë” ë‚®ì€ ì œí’ˆ ì°¾ê¸°
            # (ë§Œì•½ ì‹ ì œí’ˆì´ë¼ ë‹¹ë¥˜/ì¹¼ë¡œë¦¬ ì •ë³´ê°€ ì—†ìœ¼ë©´ 9999ë¡œ ê°€ì •í•˜ì—¬ ë¬´ì¡°ê±´ ì¶”ì²œë°›ê²Œ í•¨)
            ref_sugar = float(current_sugar) if current_sugar is not None else 9999
            ref_kcal = float(current_kcal) if current_kcal is not None else 9999
            
            sql = """
            SELECT 
                p.product_name, 
                p.kind_name, 
                p.manufacturer,
                n.amt_num1 AS kcal, 
                n.amt_num7 AS sugar
            FROM products p
            LEFT JOIN nutrition_facts_raw n ON p.report_no = n.report_no
            WHERE p.kind_name = %s
              AND (n.amt_num7 < %s OR n.amt_num1 < %s)
            """
            
            # DBì— ìˆëŠ” ì œí’ˆì´ë©´ ìê¸° ìì‹ ì€ ì¶”ì²œ ì œì™¸
            params = [category, ref_sugar, ref_kcal]
            if current_report_no:
                sql += " AND p.report_no != %s"
                params.append(current_report_no)
                
            sql += " ORDER BY n.amt_num7 ASC, n.amt_num1 ASC LIMIT 3"
            
            cursor.execute(sql, tuple(params))
            recommendations = cursor.fetchall()
            
    finally:
        conn.close()
    
    return recommendations

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. ë©”ì¸ ê¸°ëŠ¥: ë°”ì½”ë“œ ìŠ¤ìº” ì‹œë®¬ë ˆì´ì…˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def process_scan(input_type, input_value):
    """
    input_type: 'barcode' ë˜ëŠ” 'raw_text' (ì‹ ì œí’ˆ ê°€ì •)
    input_value: ë°”ì½”ë“œ ë²ˆí˜¸ ë˜ëŠ” 'ì œí’ˆëª… + ì›ì¬ë£Œ' í…ìŠ¤íŠ¸
    """
    conn = pymysql.connect(**DB_CONFIG)
    product_info = {}
    
    print(f"\nğŸ“² [ìŠ¤ìº” ê°ì§€] ì…ë ¥ê°’: {input_value} ({input_type})")
    
    try:
        with conn.cursor() as cursor:
            # [Case A] ë°”ì½”ë“œ ìŠ¤ìº” (DB ì¡°íšŒ)
            if input_type == 'barcode':
                # 1. ë°”ì½”ë“œë¡œ report_no ì°¾ê¸°
                sql_barcode = "SELECT report_no FROM product_barcodes WHERE barcode = %s"
                cursor.execute(sql_barcode, (input_value,))
                res = cursor.fetchone()
                
                if res:
                    report_no = res['report_no']
                    # 2. ì œí’ˆ ìƒì„¸ ì •ë³´ ì¡°íšŒ
                    sql_prod = """
                    SELECT p.report_no, p.product_name, p.kind_name, 
                           n.amt_num1 AS kcal, n.amt_num7 AS sugar
                    FROM products p
                    LEFT JOIN nutrition_facts_raw n ON p.report_no = n.report_no
                    WHERE p.report_no = %s
                    """
                    cursor.execute(sql_prod, (report_no,))
                    product_info = cursor.fetchone()
                    print(f"   â¡ DB ë§¤ì¹­ ì„±ê³µ! : {product_info['product_name']} ({product_info['kind_name']})")
                else:
                    print("   â¡ DBì— ì—†ëŠ” ë°”ì½”ë“œì…ë‹ˆë‹¤. (ì‹ ì œí’ˆìœ¼ë¡œ ê°„ì£¼)")
            
            # [Case B] ì‹ ì œí’ˆ (ë˜ëŠ” DBì— ì—†ëŠ” ì œí’ˆ) -> AI ì˜ˆì¸¡ ì‹¤í–‰
            if not product_info:
                print("ğŸ¤– AI ëª¨ë¸ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤...")
                # ì‹ ì œí’ˆì´ë¼ê³  ê°€ì •í•˜ê³  í…ìŠ¤íŠ¸(ì´ë¦„+ì›ì¬ë£Œ)ë¥¼ ë°›ëŠ”ë‹¤ê³  ì¹©ì‹œë‹¤.
                # í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì„ì˜ì˜ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.
                if input_type == 'barcode':
                     # ë°”ì½”ë“œë§Œ ìˆê³  ì •ë³´ê°€ ì—†ìœ¼ë©´ ì˜ˆì¸¡ ë¶ˆê°€í•˜ë¯€ë¡œ ê°€ìƒì˜ í…ìŠ¤íŠ¸ ì‚¬ìš© (ì‹œì—°ìš©)
                     dummy_text = "ì‹ ì œí’ˆ ì´ˆì½” ë¼ë–¼ ìš°ìœ  ì„¤íƒ• ì½”ì½”ì•„ ë¶„ë§"
                     print(f"   (ì‹ ì œí’ˆ ì •ë³´ ìˆ˜ë™ ì…ë ¥ ê°€ì •: '{dummy_text}')")
                     input_value = dummy_text
                
                # ì˜ˆì¸¡ ìˆ˜í–‰
                input_vec = vectorizer.transform([input_value])
                predicted_category = rf_model.predict(input_vec)[0]
                proba = np.max(rf_model.predict_proba(input_vec)) * 100
                
                print(f"   â¡ AI ì˜ˆì¸¡ ê²°ê³¼: '{predicted_category}' (í™•ì‹ ë„: {proba:.2f}%)")
                
                product_info = {
                    'product_name': 'ì•Œ ìˆ˜ ì—†ëŠ” ì‹ ì œí’ˆ',
                    'kind_name': predicted_category,
                    'sugar': None, # ì •ë³´ ì—†ìŒ
                    'kcal': None,
                    'report_no': None
                }

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 4. ê²°ê³¼ ë° ì¶”ì²œ ì¶œë ¥
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        print("-" * 50)
        print(f"ğŸ“Œ [ì œí’ˆ ì •ë³´]")
        print(f"   ì œí’ˆëª…: {product_info.get('product_name')}")
        print(f"   ì¹´í…Œê³ ë¦¬: {product_info['kind_name']}")
        print(f"   ì˜ì–‘ì„±ë¶„: ë‹¹ë¥˜ {product_info.get('sugar', '?')}g, ì—´ëŸ‰ {product_info.get('kcal', '?')}kcal")
        print("-" * 50)
        
        # ì¶”ì²œ ë°›ê¸°
        recs = find_healthier_alternatives(
            product_info['kind_name'], 
            product_info.get('sugar'), 
            product_info.get('kcal'),
            product_info.get('report_no')
        )
        
        print(f"ğŸ¥— [{product_info['kind_name']}] ì¹´í…Œê³ ë¦¬ì˜ ë” ê±´ê°•í•œ ì¶”ì²œ ì œí’ˆ!")
        if recs:
            for i, r in enumerate(recs, 1):
                s_val = f"{r['sugar']}g" if r['sugar'] is not None else "?g"
                k_val = f"{r['kcal']}kcal" if r['kcal'] is not None else "?kcal"
                print(f"   {i}. {r['product_name']} (ì œì¡°: {r['manufacturer']})")
                print(f"      â”” ë‹¹ë¥˜ {s_val}, ì—´ëŸ‰ {k_val}")
        else:
            print("   (ì´ë¯¸ ê°€ì¥ ê±´ê°•í•œ ì œí’ˆì´ê±°ë‚˜, ì¶”ì²œí•  ëŒ€ì•ˆì´ ì—†ìŠµë‹ˆë‹¤)")
        print("-" * 50)

    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
    finally:
        conn.close()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# [í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤]
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# 1. DBì— ìˆëŠ” ë°”ì½”ë“œ ìŠ¤ìº” (ì˜ˆ: ì½œë¼, ë‘ìœ  ë“± ë³¸ì¸ DBì— ìˆëŠ” ë°”ì½”ë“œ ì…ë ¥)
# (ì‹¤ì œ ë°”ì½”ë“œë¥¼ ëª°ë¼ì„œ ì„ì˜ì˜ ìˆ«ìë¥¼ ë„£ìŠµë‹ˆë‹¤. ë³¸ì¸ DB ë°”ì½”ë“œë¡œ ë°”ê¿”ë³´ì„¸ìš”)
print("\nğŸ”µ ì‹œë‚˜ë¦¬ì˜¤ 1: DBì— ìˆëŠ” ì œí’ˆ ìŠ¤ìº”")
process_scan('barcode', '8801069182438') 

# 2. DBì— ì—†ëŠ” ì‹ ì œí’ˆ í…ìŠ¤íŠ¸ ì…ë ¥ (AI ì˜ˆì¸¡ í…ŒìŠ¤íŠ¸)
print("\n\nğŸ”µ ì‹œë‚˜ë¦¬ì˜¤ 2: ì‹ ì œí’ˆ ë°ì´í„° ì…ë ¥ (AI ì˜ˆì¸¡)")
# ëª¨ë¸ì´ 'ì»¤í”¼'ë¡œ ì˜ˆì¸¡í•´ì•¼ í•¨
process_scan('raw_text', 'ìŠ¤íƒ€ë²…ìŠ¤ ë”ë¸”ìƒ· ì—ìŠ¤í”„ë ˆì†Œ í¬ë¦¼ ì»¤í”¼ì›ë‘ ìš°ìœ ') 

# 3. í—·ê°ˆë¦¬ëŠ” ì œí’ˆ ì…ë ¥
print("\n\nğŸ”µ ì‹œë‚˜ë¦¬ì˜¤ 3: í—·ê°ˆë¦¬ëŠ” ì‹ ì œí’ˆ ì…ë ¥")
# ëª¨ë¸ì´ 'ê³¼ì±„ìŒë£Œ'ë¡œ ì˜ˆì¸¡í•´ì•¼ í•¨
process_scan('raw_text', 'ìì—°ì€ 100% ì œì£¼ ê°ê·¤ ì£¼ìŠ¤ ë†ì¶•ì•¡ ì„¤íƒ• ì •ì œìˆ˜')